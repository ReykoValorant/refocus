<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Refocus</title>
  <link rel="stylesheet" href="fonts/fonts.css">

  <style>
    :root {
      --orange:       #e6a587;
      --coral:        #f0967a;
      --pink:         #eb5062;
      --pink-bright:  #ff6b7a;

      --grad-warm:    linear-gradient(135deg, var(--orange), var(--coral));
      --grad-hot:     linear-gradient(135deg, var(--coral), var(--pink));
      --grad-full:    linear-gradient(135deg, var(--orange) 0%, var(--coral) 45%, var(--pink) 100%);

      --glow-orange:  rgba(230,165,135,0.28);
      --glow-coral:   rgba(240,150,122,0.32);
      --glow-pink:    rgba(235,80,98,0.45);

      --bg:      #000000;
      --surface: rgba(255,255,255,0.018);
      --surface2: rgba(255,255,255,0.03);

      --border:  rgba(235,80,98,0.18);
      --border2: rgba(255,255,255,0.055);
      --border3: rgba(255,255,255,0.08);

      --text:  rgba(255,255,255,0.95);
      --sub:   rgba(255,255,255,0.52);
      --dim:   rgba(255,255,255,0.28);

      --ok:   #3dd68c;
      --warn: #f5a623;
      --bad:  #ff7766;

      --font-h: 'Barlow Condensed', sans-serif;
      --font-b: 'Barlow', sans-serif;
      --ease: cubic-bezier(.16,1,.3,1);
      --ease-back: cubic-bezier(.34,1.56,.64,1);
    }

    *, *::before, *::after { box-sizing: border-box; margin: 0; padding: 0; }
    html, body { height: 100%; overflow: hidden; color-scheme: dark; }

    body {
      background: var(--bg);
      font-family: var(--font-b);
      color: var(--text);
      -webkit-font-smoothing: antialiased;
    }

    /* Grain */
    body::before {
      content: "";
      position: fixed; inset: 0;
      background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 200 200' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='n'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.85' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23n)'/%3E%3C/svg%3E");
      opacity: 0.025; pointer-events: none; z-index: 9999;
    }

    /* Scanlines */
    body::after {
      content: "";
      position: fixed; inset: 0;
      background-image: repeating-linear-gradient(0deg, transparent, transparent 3px, rgba(255,255,255,0.006) 3px, rgba(255,255,255,0.006) 4px);
      pointer-events: none; z-index: 9998;
    }

    /* Atmosphere */
    .atmo {
      position: fixed; inset: 0; pointer-events: none; z-index: 0;
      background:
        radial-gradient(ellipse 700px 400px at -6% -10%, rgba(240,150,122,0.09) 0%, transparent 60%),
        radial-gradient(ellipse 500px 600px at 108% 2%,  rgba(235,80,98,0.04) 0%, transparent 55%),
        radial-gradient(ellipse 900px 450px at 50% 108%, rgba(4,5,8,0.90) 0%, transparent 65%);
    }

    .shell { position: relative; z-index: 1; height: 100%; display: flex; flex-direction: column; }

    /* ── HEADER ── */
    header {
      flex: 0 0 auto;
      height: 58px;
      display: flex; align-items: center; justify-content: space-between;
      padding: 0 20px;
      position: relative;
      background: rgba(0,0,0,0.20);
    }
    header::before {
      content: "";
      position: absolute; top: 0; left: 0; right: 0; height: 2px;
      background: linear-gradient(90deg, var(--orange) 0%, var(--coral) 38%, var(--pink) 65%, transparent 90%);
      opacity: 0.85;
    }
    header::after {
      content: "";
      position: absolute; bottom: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, rgba(240,150,122,0.18) 0%, rgba(240,150,122,0.06) 40%, transparent 80%);
    }

    .brand { display: flex; align-items: center; gap: 11px; animation: rise 480ms var(--ease) both; }

    .brand-logo {
      width: 36px; height: 36px; border-radius: 10px;
      overflow: hidden; flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.10);
      background: rgba(0,0,0,0.50);
      box-shadow: 0 0 0 1px rgba(240,150,122,0.16) inset, 0 6px 20px rgba(0,0,0,0.55), 0 0 20px rgba(240,150,122,0.10);
      transition: box-shadow 400ms;
    }
    .brand-logo.pulsing { animation: logoPulse 1.3s ease-in-out infinite; }
    @keyframes logoPulse {
      0%,100% { box-shadow: 0 0 0 1px rgba(240,150,122,0.16) inset, 0 6px 20px rgba(0,0,0,0.55), 0 0 20px rgba(240,150,122,0.10); }
      50%     { box-shadow: 0 0 0 1px rgba(240,150,122,0.36) inset, 0 6px 20px rgba(0,0,0,0.55), 0 0 36px rgba(240,150,122,0.24); }
    }
    .brand-logo img { width: 100%; height: 100%; display: block; object-fit: cover; }

    .brand-text { display: flex; flex-direction: column; gap: 2px; }
    .brand-name {
      font-family: var(--font-h); font-size: 19px; font-weight: 800;
      letter-spacing: 3.5px; text-transform: uppercase; color: #fff; line-height: 1;
    }
    .brand-sub {
      font-size: 9px; font-weight: 600; letter-spacing: 2px; text-transform: uppercase; color: var(--sub);
    }
    .brand-sub em { font-style: normal; color: var(--coral); font-weight: 700; }

    .hdr-right { display: flex; align-items: center; gap: 8px; animation: rise 480ms 70ms var(--ease) both; }
    .v-chip {
      font-family: var(--font-h); font-size: 10px; font-weight: 700;
      letter-spacing: 1.6px; text-transform: uppercase;
      color: var(--dim); padding: 4px 9px;
      border: 1px solid rgba(255,255,255,0.07); border-radius: 5px;
      background: rgba(255,255,255,0.018);
    }

    /* ── MAIN ── */
    main {
      flex: 1 1 0; min-height: 0;
      display: grid;
      grid-template-columns: minmax(0,1fr) 252px;
      padding: 12px 20px 14px;
      gap: 12px;
    }

    /* LEFT */
    .col-left {
      display: flex; flex-direction: column; gap: 10px;
      min-height: 0; overflow-y: auto; overflow-x: hidden; padding-right: 2px;
    }
    .col-left::-webkit-scrollbar { width: 3px; }
    .col-left::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    .col-left::-webkit-scrollbar-track { background: transparent; }

    /* PANEL */
    .panel {
      border-radius: 10px;
      border: 1px solid var(--border2);
      background: var(--surface);
      overflow: hidden; position: relative;
      animation: rise 420ms var(--ease) both;
      transition: border-color 280ms var(--ease), background 280ms var(--ease);
    }
    .panel:hover { border-color: var(--border3); background: var(--surface2); }
    .panel:nth-child(1) { animation-delay: 20ms; }
    .panel:nth-child(2) { animation-delay: 75ms; }
    /* Top shimmer */
    .panel::before {
      content: "";
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, rgba(255,255,255,0.07) 0%, rgba(255,255,255,0.02) 60%, transparent 100%);
    }

    .panel-head {
      padding: 9px 14px 8px;
      border-bottom: 1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.012);
      display: flex; align-items: center; gap: 8px;
    }
    .pip {
      width: 2px; height: 13px; border-radius: 999px;
      background: linear-gradient(180deg, var(--coral), var(--pink));
      box-shadow: 0 0 8px var(--glow-pink);
    }
    .panel-label {
      font-family: var(--font-h); font-size: 10px; font-weight: 700;
      letter-spacing: 2.4px; text-transform: uppercase; color: var(--sub);
    }

    .panel-body { padding: 9px 10px 10px; display: flex; flex-direction: column; gap: 6px; }

    /* STATUS ITEMS */
    .s-item {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      padding: 9px 11px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.04);
      background: rgba(0,0,0,0.18);
      transition: border-color 220ms var(--ease), background 220ms;
    }
    .s-item:hover { border-color: rgba(235,80,98,0.15); background: rgba(0,0,0,0.28); }

    .s-info { flex: 1; min-width: 0; }
    .s-name {
      font-family: var(--font-h); font-size: 12.5px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase;
      color: rgba(255,255,255,0.82); line-height: 1;
    }
    .s-desc {
      margin-top: 3px; font-size: 11.5px; font-weight: 500;
      color: var(--sub); white-space: nowrap; overflow: hidden; text-overflow: ellipsis;
    }

    /* BADGES */
    .badge {
      display: flex; align-items: center; gap: 5px;
      padding: 3px 8px; border-radius: 999px;
      font-family: var(--font-h); font-size: 10px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase; white-space: nowrap;
      border: 1px solid rgba(255,255,255,0.08); background: rgba(0,0,0,0.28);
      color: var(--sub);
      transition: border-color 300ms, background 300ms, color 300ms;
    }
    .bdot {
      width: 5px; height: 5px; border-radius: 999px;
      background: var(--dim); flex: 0 0 auto;
      transition: background 300ms, box-shadow 300ms;
    }
    .badge.ok   { border-color: rgba(61,214,140,0.22);  background: rgba(61,214,140,0.06);  color: rgba(130,230,180,0.90); }
    .badge.ok   .bdot { background: var(--ok);   box-shadow: 0 0 6px var(--ok); }
    .badge.warn { border-color: rgba(245,166,35,0.22);  background: rgba(245,166,35,0.06);  color: rgba(245,190,90,0.90); }
    .badge.warn .bdot { background: var(--warn);  box-shadow: 0 0 6px var(--warn); }
    .badge.bad  { border-color: rgba(255,68,102,0.22);  background: rgba(255,68,102,0.06);  color: rgba(255,110,130,0.90); }
    .badge.bad  .bdot { background: var(--bad);   box-shadow: 0 0 6px var(--bad); }
    .badge.check { border-color: rgba(255,255,255,0.07); background: rgba(0,0,0,0.22); color: var(--sub); }
    .badge.pulsing .bdot { animation: bdotPulse 1.1s ease-in-out infinite; }
    @keyframes bdotPulse { 0%,100% { opacity: 1; } 50% { opacity: 0.25; } }

    /* SETTING ITEMS */
    .set-item {
      display: flex; align-items: center; justify-content: space-between; gap: 10px;
      padding: 9px 11px; border-radius: 8px;
      border: 1px solid rgba(255,255,255,0.04); background: rgba(0,0,0,0.18);
      transition: border-color 220ms var(--ease), background 220ms;
    }
    .set-item:hover { border-color: rgba(235,80,98,0.14); background: rgba(0,0,0,0.26); }

    .set-name {
      font-family: var(--font-h); font-size: 12.5px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase;
      color: rgba(255,255,255,0.82); line-height: 1;
    }
    .set-desc { margin-top: 3px; font-size: 11.5px; font-weight: 500; color: var(--sub); }

    /* SELECT */
    select {
      appearance: none; border-radius: 7px;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.40);
      padding: 5px 24px 5px 8px;
      color: rgba(255,255,255,0.80);
      font-family: var(--font-h); font-weight: 600;
      font-size: 11px; letter-spacing: 0.5px; text-transform: uppercase;
      outline: none; cursor: pointer; min-width: 120px;
      color-scheme: dark;
      background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='8' height='5'%3E%3Cpath d='M0 0l4 5 4-5z' fill='rgba(255,255,255,0.28)'/%3E%3C/svg%3E");
      background-repeat: no-repeat; background-position: right 7px center;
      transition: all 220ms var(--ease);
    }
    select:hover { border-color: rgba(235,80,98,0.20); background-color: rgba(0,0,0,0.46); }
    select:focus { border-color: rgba(235,80,98,0.40); box-shadow: 0 0 0 2px rgba(235,80,98,0.10); }
    option { background: #0c0e14; font-family: sans-serif; text-transform: none; }

    /* TOGGLE */
    .tog {
      width: 40px; height: 22px; border-radius: 999px; flex: 0 0 auto;
      border: 1px solid rgba(255,255,255,0.08);
      background: rgba(0,0,0,0.42); position: relative; cursor: pointer;
      transition: border-color 200ms, background 200ms, box-shadow 200ms;
    }
    .tog-k {
      position: absolute; top: 2px; left: 2px;
      width: 18px; height: 18px; border-radius: 999px;
      background: rgba(255,255,255,0.28); border: 1px solid rgba(255,255,255,0.10);
      box-shadow: 0 2px 5px rgba(0,0,0,0.45);
      transition: left 160ms cubic-bezier(.25,.9,.2,1), background 160ms, box-shadow 160ms;
    }
    .tog.on {
      border-color: rgba(235,80,98,0.48);
      background: linear-gradient(135deg, rgba(240,150,122,0.11), rgba(235,80,98,0.14));
      box-shadow: 0 0 18px rgba(235,80,98,0.22), 0 0 0 1px rgba(235,80,98,0.12) inset;
    }
    .tog.on .tog-k {
      left: 20px;
      background: var(--grad-hot);
      border-color: rgba(255,255,255,0.28);
      box-shadow: 0 2px 8px rgba(235,80,98,0.48), 0 0 14px var(--glow-pink);
    }

    /* PREVIEW BUTTON */
    .preview-btn {
      padding: 5px 12px; border-radius: 7px;
      border: 1px solid rgba(235,80,98,0.35);
      background: linear-gradient(135deg, rgba(240,150,122,0.08), rgba(235,80,98,0.10));
      color: rgba(255,185,175,0.90);
      font-family: var(--font-h); font-size: 11px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase;
      cursor: pointer; white-space: nowrap;
      transition: all 170ms var(--ease);
      position: relative; overflow: hidden;
    }
    .preview-btn::before { content: ""; position: absolute; inset: 0; background: var(--grad-hot); opacity: 0; transition: opacity 170ms; }
    .preview-btn:hover::before { opacity: 0.18; }
    .preview-btn:hover { border-color: var(--pink); color: #ffd9d4; box-shadow: 0 0 16px var(--glow-pink); transform: translateY(-1px); }
    .preview-btn:active { transform: translateY(0) scale(0.97); }

    /* DEV CONSOLE */
    .dev-panel {
      border-radius: 10px; border: 1px solid rgba(255,255,255,0.06);
      background: rgba(0,0,0,0.38); overflow: hidden;
      display: none; flex-shrink: 0;
      animation: rise 260ms var(--ease) both;
    }
    .dev-panel.open { display: block; }
    .dev-head {
      padding: 7px 12px; border-bottom: 1px solid rgba(255,255,255,0.04);
      background: rgba(255,255,255,0.014);
      display: flex; align-items: center; justify-content: space-between;
    }
    .dev-title { display: flex; align-items: center; gap: 7px; font-family: var(--font-h); font-size: 10px; font-weight: 700; letter-spacing: 2px; text-transform: uppercase; color: var(--sub); }
    .dev-btns { display: flex; gap: 4px; }
    .d-btn {
      padding: 3px 9px; border-radius: 5px; border: 1px solid rgba(255,255,255,0.08);
      background: rgba(255,255,255,0.025); color: var(--sub);
      font-family: var(--font-h); font-size: 10px; font-weight: 700;
      letter-spacing: 0.8px; text-transform: uppercase; cursor: pointer;
      transition: background 140ms, color 140ms;
    }
    .d-btn:hover { background: rgba(255,255,255,0.06); color: var(--text); }
    .dev-log {
      padding: 8px 11px; height: 120px; overflow-y: auto;
      font-family: ui-monospace, 'Fira Code', Menlo, monospace;
      font-size: 10px; line-height: 1.65;
      color: rgba(255,255,255,0.55); white-space: pre-wrap; word-break: break-all;
    }
    .dev-log::-webkit-scrollbar { width: 3px; }
    .dev-log::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    .meta-row { font-size: 10px; color: var(--sub); padding: 4px 12px 2px; display: none; }

    /* ── RIGHT COLUMN ── */
    .col-right { flex: 0 0 252px; display: flex; flex-direction: column; min-height: 0; }

    /* Rate panel fills full height */
    .rate-panel {
      flex: 1; min-height: 0;
      border-radius: 10px; border: 1px solid var(--border2);
      background: var(--surface);
      display: flex; flex-direction: column; overflow: hidden; position: relative;
      animation: rise 420ms 55ms var(--ease) both;
    }
    .rate-panel::before {
      content: "";
      position: absolute; top: 0; left: 0; right: 0; height: 1px;
      background: linear-gradient(90deg, rgba(240,150,122,0.50) 0%, rgba(235,80,98,0.18) 50%, transparent 100%);
    }
    .rate-panel:hover { border-color: var(--border3); }

    /* ANIMATIONS */
    @keyframes rise {
      from { opacity: 0; transform: translateY(7px); }
      to   { opacity: 1; transform: translateY(0); }
    }

    ::-webkit-scrollbar { width: 3px; }
    ::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }
    ::-webkit-scrollbar-track { background: transparent; }

    /* Rate panel empty state */
    .rate-empty {
      flex: 1; display: flex; flex-direction: column; align-items: center; justify-content: center;
      padding: 20px 18px; text-align: center; gap: 8px;
    }
    .rate-empty-icon { font-size: 26px; opacity: 0.35; }
    .rate-empty-text {
      font-size: 12px; font-weight: 500; color: var(--sub); line-height: 1.7;
    }

    /* Rate list */
    .rate-list {
      flex: 1; min-height: 0;
      display: flex; flex-direction: column; gap: 6px;
      padding: 9px 10px 4px;
      overflow-y: auto; overflow-x: hidden;
    }
    .rate-list::-webkit-scrollbar { width: 3px; }
    .rate-list::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.08); border-radius: 3px; }

    /* Rate card */
    .rate-card {
      border-radius: 8px; border: 1px solid rgba(255,255,255,0.05);
      background: rgba(0,0,0,0.22); padding: 9px 10px 8px;
      flex-shrink: 0;
      transition: border-color 200ms var(--ease), background 200ms;
    }
    .rate-card:hover { border-color: rgba(255,255,255,0.09); background: rgba(0,0,0,0.30); }
    .rate-card.rated-up   { border-color: rgba(61,214,140,0.28); background: rgba(61,214,140,0.04); }
    .rate-card.rated-down { border-color: rgba(255,100,80,0.28); background: rgba(255,100,80,0.04); }
    .rate-card.skipped    { opacity: 0.38; }

    .rate-msg-text {
      font-family: var(--font-h); font-size: 13px; font-weight: 700;
      letter-spacing: 0.3px;
      color: rgba(255,255,255,0.88); line-height: 1.3;
      margin-bottom: 4px;
    }
    .rate-ctx {
      font-size: 10px; font-weight: 500; color: var(--dim);
      margin-bottom: 7px; letter-spacing: 0.2px;
    }

    .rate-btns { display: flex; gap: 4px; }
    .rate-btn {
      padding: 3px 7px; border-radius: 5px; cursor: pointer;
      font-family: var(--font-h); font-size: 10.5px; font-weight: 700;
      letter-spacing: 0.4px; border: 1px solid rgba(255,255,255,0.07);
      background: rgba(255,255,255,0.03); color: var(--dim);
      transition: all 140ms var(--ease); flex: 1; text-align: center;
    }
    .rate-btn:hover { background: rgba(255,255,255,0.07); color: var(--sub); }
    .rate-btn.active-up   { border-color: rgba(61,214,140,0.55); background: rgba(61,214,140,0.14); color: #7fe8b4; box-shadow: 0 0 8px rgba(61,214,140,0.18); }
    .rate-btn.active-down { border-color: rgba(255,100,80,0.55);  background: rgba(255,100,80,0.14);  color: #ffa090; box-shadow: 0 0 8px rgba(255,100,80,0.18); }

    /* Rate footer */
    .rate-footer {
      flex-shrink: 0;
      padding: 8px 10px 10px;
      border-top: 1px solid rgba(255,255,255,0.04);
      display: flex; flex-direction: column; gap: 6px;
      background: rgba(0,0,0,0.15);
    }
    .rate-counter {
      font-family: var(--font-h); font-size: 10px; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase;
      color: var(--dim); text-align: right;
    }
    .rate-comment {
      width: 100%; box-sizing: border-box;
      border-radius: 7px; resize: none;
      border: 1px solid rgba(255,255,255,0.06); background: rgba(0,0,0,0.30);
      color: rgba(255,255,255,0.75); font-family: var(--font-b);
      font-size: 11px; padding: 6px 9px; outline: none;
      transition: border-color 200ms;
    }
    .rate-comment:focus { border-color: rgba(235,80,98,0.35); }
    .rate-comment::placeholder { color: var(--dim); }

    .submit-btn {
      padding: 7px 14px; border-radius: 7px; cursor: pointer;
      font-family: var(--font-h); font-size: 11px; font-weight: 700;
      letter-spacing: 1px; text-transform: uppercase;
      border: 1px solid rgba(235,80,98,0.40);
      background: linear-gradient(135deg, rgba(240,150,122,0.09), rgba(235,80,98,0.12));
      color: rgba(255,185,175,0.90);
      transition: all 170ms var(--ease);
      position: relative; overflow: hidden;
    }
    .submit-btn::before { content: ""; position: absolute; inset: 0; background: var(--grad-hot); opacity: 0; transition: opacity 170ms; }
    .submit-btn:hover::before { opacity: 0.20; }
    .submit-btn:hover { border-color: var(--pink); color: #ffd9d4; box-shadow: 0 0 14px var(--glow-pink); transform: translateY(-1px); }
    .submit-btn:disabled { opacity: 0.35; cursor: not-allowed; transform: none; box-shadow: none; }

    .rate-status {
      font-size: 11px; font-weight: 500; text-align: center; line-height: 1.5; padding: 2px 0;
    }
    .rate-status.ok  { color: rgba(100,220,160,0.85); }
    .rate-status.err { color: rgba(255,140,130,0.85); }
  </style>
</head>
<body>
  <div class="atmo"></div>
  <div class="shell">

    <!-- HEADER -->
    <header>
      <div class="brand">
        <div class="brand-logo" id="brandLogo"><img src="launcher_icon.ico" alt=""></div>
        <div class="brand-text">
          <div class="brand-name">Refocus</div>
          <div class="brand-sub">Refocus. Reset. <em>Dominate.</em></div>
        </div>
      </div>
      <div class="hdr-right">
        <div class="v-chip" id="vChip">v0.4.0</div>
      </div>
    </header>

    <!-- MAIN -->
    <main>

      <!-- LEFT -->
      <div class="col-left">

        <!-- Status -->
        <div class="panel">
          <div class="panel-head">
            <div class="pip"></div>
            <div class="panel-label">Status</div>
          </div>
          <div class="panel-body">
            <div class="s-item">
              <div class="s-info">
                <div class="s-name">Valorant</div>
                <div class="s-desc" id="subValorant">Waiting for Valorant...</div>
              </div>
              <div class="badge check pulsing" id="badgeValorant">
                <span class="bdot"></span><span>Checking</span>
              </div>
            </div>
            <div class="s-item">
              <div class="s-info">
                <div class="s-name">Game Events</div>
                <div class="s-desc" id="subGep">Overwolf GEP stream</div>
              </div>
              <div class="badge check pulsing" id="badgeGep">
                <span class="bdot"></span><span>Checking</span>
              </div>
            </div>
          </div>
          <div class="meta-row" id="metaLine">
            Game ID: <strong id="gameId">-</strong> &nbsp;&middot;&nbsp; Instance: <strong id="instId">-</strong>
          </div>
        </div>

        <!-- Settings -->
        <div class="panel">
          <div class="panel-head">
            <div class="pip"></div>
            <div class="panel-label">Settings</div>
          </div>
          <div class="panel-body">
            <div class="set-item">
              <div>
                <div class="set-name">Enable overlay</div>
                <div class="set-desc">Show cues in-game</div>
              </div>
              <div class="tog on" id="swOverlay"><div class="tog-k"></div></div>
            </div>
            <div class="set-item">
              <div>
                <div class="set-name">Position</div>
                <div class="set-desc">Where the cue appears</div>
              </div>
              <select id="selPos">
                <option value="tr" selected>Top right</option>
                <option value="tl">Top left</option>
                <option value="br">Bottom right</option>
                <option value="bl">Bottom left</option>
              </select>
            </div>
            <div class="set-item">
              <div>
                <div class="set-name">Intensity</div>
                <div class="set-desc">Cue display duration</div>
              </div>
              <select id="selIntensity">
                <option value="gentle">Gentle — 9s</option>
                <option value="normal" selected>Normal — 10s</option>
                <option value="strict">Strict — 11s</option>
              </select>
            </div>
            <div class="set-item">
              <div>
                <div class="set-name">Dev mode</div>
                <div class="set-desc">Show diagnostic console</div>
              </div>
              <div class="tog" id="swDev"><div class="tog-k"></div></div>
            </div>
            <div class="set-item">
              <div>
                <div class="set-name">Preview cue</div>
                <div class="set-desc">Test overlay position &amp; style</div>
              </div>
              <button class="preview-btn" id="btnPreview">Show cue</button>
            </div>
          </div>
        </div>

        <!-- Dev console -->
        <div class="dev-panel" id="consoleWrap">
          <div class="dev-head">
            <div class="dev-title"><div class="pip"></div>Console</div>
            <div class="dev-btns">
              <button class="d-btn" id="btnCopy">Copy</button>
              <button class="d-btn" id="btnClear">Clear</button>
            </div>
          </div>
          <div class="dev-log" id="console"></div>
        </div>

      </div>

      <!-- RIGHT: AI Message Ranker -->
      <div class="col-right">
        <div class="rate-panel" id="ratePanel">
          <div class="panel-head">
            <div class="pip"></div>
            <div class="panel-label">AI Message Ranker</div>
          </div>
          <div id="rateEmpty" class="rate-empty">
            <div class="rate-empty-icon">&#128203;</div>
            <div class="rate-empty-text">No messages to rate yet.<br>Play a game first!</div>
          </div>
          <div class="rate-list" id="rateList" style="display:none;"></div>
          <div class="rate-footer" id="rateFooter" style="display:none;">
            <button class="submit-btn" id="btnSubmit">Train My Personal Feed</button>
            <div class="rate-status" id="rateStatus"></div>
          </div>
        </div>
      </div>

    </main>
  </div>

<script>
  const VERSION = "0.4.0";
  document.getElementById("vChip").textContent = "v" + VERSION;

  const brandLogo     = document.getElementById("brandLogo");
  const badgeValorant = document.getElementById("badgeValorant");
  const badgeGep      = document.getElementById("badgeGep");
  const subValorant   = document.getElementById("subValorant");
  const subGep        = document.getElementById("subGep");
  const metaLine      = document.getElementById("metaLine");
  const gameIdEl      = document.getElementById("gameId");
  const instIdEl      = document.getElementById("instId");
  const swOverlay     = document.getElementById("swOverlay");
  const selPos        = document.getElementById("selPos");
  const selIntensity  = document.getElementById("selIntensity");
  const swDev         = document.getElementById("swDev");
  const consoleWrap   = document.getElementById("consoleWrap");
  const btnPreview    = document.getElementById("btnPreview");
  const consoleEl     = document.getElementById("console");
  const btnCopy       = document.getElementById("btnCopy");
  const btnClear      = document.getElementById("btnClear");
  const ratePanel     = document.getElementById("ratePanel");
  const rateList      = document.getElementById("rateList");
  const rateEmpty     = document.getElementById("rateEmpty");
  const rateFooter    = document.getElementById("rateFooter");
  const btnSubmit     = document.getElementById("btnSubmit");
  const rateStatus    = document.getElementById("rateStatus");

  // Single delegated listener — attached once so repeated loadRatePanel() calls don't stack listeners
  rateList.addEventListener("click", (e) => {
    const btn = e.target.closest(".rate-btn");
    if (!btn) return;
    const idx = parseInt(btn.dataset.idx, 10);
    const action = btn.dataset.action;
    if (isNaN(idx)) return;
    setRating(idx, action);
  });

  let state = { overlayEnabled: true, position: "tr", intensity: "normal", devMode: false };
  let backgroundId = null;
  const UNRATED_KEY  = "unrated_messages";
  const RATINGS_KEY  = "refocus_ratings";

  function sendToBackground(id, content) {
    if (!backgroundId) return;
    try { overwolf.windows.sendMessage(backgroundId, id, content || {}, () => {}); } catch(e) {}
  }

  function setPill(el, mode, text) {
    el.classList.remove("ok","bad","warn","check");
    el.classList.add(mode);
    el.classList.toggle("pulsing", mode === "check" || mode === "warn");
    el.querySelector("span:last-child").textContent = text;
  }

  function setTog(el, on) { el.classList.toggle("on", !!on); }

  function applyUi() {
    setTog(swOverlay, state.overlayEnabled);
    selPos.value       = state.position  || "tr";
    selIntensity.value = state.intensity || "normal";
    setTog(swDev, state.devMode);
    metaLine.style.display = state.devMode ? "block" : "none";
    consoleWrap.classList.toggle("open", !!state.devMode);
    if (!state.devMode) consoleEl.textContent = "";
    loadRatePanel();
  }

  function pushSettings() { sendToBackground("settings_update", state); }

  function log(line) {
    if (!state.devMode) return;
    const ts = new Date().toLocaleTimeString();
    consoleEl.textContent += "[" + ts + "] " + line + "\n";
    consoleEl.scrollTop = consoleEl.scrollHeight;
  }

  swOverlay.addEventListener("click",    () => { state.overlayEnabled = !state.overlayEnabled; applyUi(); pushSettings(); });
  swDev.addEventListener("click",        () => { state.devMode = !state.devMode;               applyUi(); pushSettings(); });
  selPos.addEventListener("change",      () => { state.position  = selPos.value;       pushSettings(); });
  selIntensity.addEventListener("change",() => { state.intensity = selIntensity.value; pushSettings(); });
  btnClear.addEventListener("click",     () => { if (state.devMode) consoleEl.textContent = ""; });
  btnCopy.addEventListener("click", async () => {
    if (!state.devMode) return;
    try { await navigator.clipboard.writeText(consoleEl.textContent || ""); } catch(e) {}
  });
  btnPreview.addEventListener("click", () => { sendToBackground("preview_toast", {}); });

  // -------- AI Message Ranker --------
  let rateItems = [];

  function loadRatingsLocal() {
    try {
      const raw = localStorage.getItem(RATINGS_KEY);
      return raw ? JSON.parse(raw) : {};
    } catch(e) { return {}; }
  }

  function loadRatePanel() {
    try {
      const raw     = localStorage.getItem(UNRATED_KEY);
      const msgs    = raw ? JSON.parse(raw) : [];
      const ratings = loadRatingsLocal();

      if (!msgs || msgs.length === 0) {
        rateEmpty.style.display = "flex";
        rateEmpty.innerHTML = '<div class="rate-empty-icon">&#128203;</div><div class="rate-empty-text">No messages to rate yet.<br>Play a game first!</div>';
        rateList.style.display   = "none";
        rateFooter.style.display = "none";
        return;
      }
      rateEmpty.style.display  = "none";
      rateList.style.display   = "flex";
      rateFooter.style.display = "flex";

      // Pre-populate existing ratings so already-rated messages show correctly
      rateItems = msgs.map(m => {
        const entry = ratings[m.messageText];
        let existingRating = null;
        if (entry) {
          if (entry.up > entry.down)        existingRating = "thumbs_up";
          else if (entry.down > entry.up)   existingRating = "thumbs_down";
        }
        return { ...m, _rating: existingRating };
      });
      renderRateList();
    } catch(e) {
      rateEmpty.style.display = "flex";
      rateEmpty.innerHTML = '<div class="rate-empty-text">Could not load messages.</div>';
      rateList.style.display   = "none";
      rateFooter.style.display = "none";
    }
  }

  function renderRateList() {
    rateList.innerHTML = "";
    rateItems.forEach((item, idx) => {
      const card = document.createElement("div");
      card.className = "rate-card";
      if (item._rating === "thumbs_up")   card.classList.add("rated-up");
      if (item._rating === "thumbs_down") card.classList.add("rated-down");
      card.dataset.idx = idx;

      const scoreStr  = item.currentScore || "?-?";
      const streakStr = item.currentStreak != null ? (item.currentStreak > 0 ? "+" + item.currentStreak : String(item.currentStreak)) : "0";
      const sideStr   = item.userSide === "atk" ? "ATK" : item.userSide === "def" ? "DEF" : (item.userSide || "?");
      const ctx = "R" + (item.roundNumber || "?") + " \u00b7 " + sideStr + " \u00b7 " + scoreStr + " \u00b7 " + (streakStr === "0" ? "\u2014" : streakStr);

      const upActive   = item._rating === "thumbs_up"   ? " active-up"   : "";
      const downActive = item._rating === "thumbs_down" ? " active-down" : "";

      card.innerHTML =
        '<div class="rate-msg-text">' + escHtml(item.messageText || "") + '</div>' +
        '<div class="rate-ctx">' + escHtml(ctx) + '</div>' +
        '<div class="rate-btns">' +
          '<button class="rate-btn' + upActive   + '" data-action="thumbs_up"   data-idx="' + idx + '">&#128077; Yes</button>' +
          '<button class="rate-btn' + downActive + '" data-action="thumbs_down" data-idx="' + idx + '">&#128078; No</button>' +
        '</div>';

      rateList.appendChild(card);
    });
  }

  function escHtml(str) {
    return String(str).replace(/&/g,"&amp;").replace(/</g,"&lt;").replace(/>/g,"&gt;");
  }

  function setRating(idx, action) {
    if (action !== "thumbs_up" && action !== "thumbs_down") return;
    const prev = rateItems[idx]._rating;
    // Toggle off if same button clicked again
    rateItems[idx]._rating = (prev === action) ? null : action;
    const newRating = rateItems[idx]._rating;

    // Save to localStorage immediately via background
    if (newRating) {
      const vote = newRating === "thumbs_up" ? 1 : -1;
      sendToBackground("rate_message", { messageText: rateItems[idx].messageText, vote: vote });
    }

    // Visual update
    const card = rateList.querySelector('[data-idx="' + idx + '"]');
    if (card) {
      card.classList.remove("rated-up","rated-down");
      if (newRating === "thumbs_up")   card.classList.add("rated-up");
      if (newRating === "thumbs_down") card.classList.add("rated-down");
      card.querySelectorAll(".rate-btn").forEach(b => {
        b.classList.remove("active-up","active-down");
        if (b.dataset.action === "thumbs_up"   && newRating === "thumbs_up")   b.classList.add("active-up");
        if (b.dataset.action === "thumbs_down" && newRating === "thumbs_down") b.classList.add("active-down");
      });
    }
  }

  btnSubmit.addEventListener("click", () => {
    const toSave = rateItems.filter(i => i._rating === "thumbs_up" || i._rating === "thumbs_down");
    if (toSave.length === 0) { showRateStatus("Rate at least one message first.", false); return; }
    // Ratings already saved instantly on click — just clear history and confirm
    try { localStorage.removeItem(UNRATED_KEY); } catch(e) {}
    rateItems = [];
    showRateStatus("Personalization updated — Refocus will prioritize tips you usually find helpful. \u2705", true);
    setTimeout(() => {
      rateList.innerHTML = "";
      rateList.style.display   = "none";
      rateFooter.style.display = "none";
      rateStatus.textContent   = "";
      rateEmpty.innerHTML = '<div class="rate-empty-icon">&#10003;</div><div class="rate-empty-text">All caught up!<br>Play another game to collect more.</div>';
      rateEmpty.style.display = "flex";
    }, 2500);
  });

  function setBrandPulse(on) { if (brandLogo) brandLogo.classList.toggle("pulsing", !!on); }

  overwolf.windows.onMessageReceived.addListener((e) => {
    if (!e || !e.id) return;

    if (e.id === "settings_current") {
      const s = e.content || {};
      if (typeof s.overlayEnabled === "boolean") state.overlayEnabled = s.overlayEnabled;
      if (s.position)  state.position  = s.position;
      if (s.intensity) state.intensity = s.intensity;
      if (typeof s.devMode === "boolean") state.devMode = s.devMode;
      applyUi();
      return;
    }

    if (e.id === "status_current") {
      const st = e.content || {};
      const running  = !!st.valorantRunning;
      const focused  = !!st.valorantFocused;
      const gepOk    = !!st.gepRequestedOk;
      const streaming = !!st.gepStreaming;

      if (running) {
        setPill(badgeValorant, "ok", "Running");
        subValorant.textContent = focused ? "Game in focus" : "Running (alt-tabbed)";
      } else {
        setPill(badgeValorant, "check", "Waiting");
        subValorant.textContent = "Waiting for Valorant...";
      }

      if (!running) {
        setPill(badgeGep, "check", "Waiting");
        subGep.textContent = "Start Valorant to connect";
      } else if (gepOk && streaming) {
        setPill(badgeGep, "ok", "Live");
        subGep.textContent = "Receiving match data";
      } else if (gepOk && !streaming) {
        setPill(badgeGep, "warn", "Standby");
        subGep.textContent = "Ready — enter a match to activate";
      } else {
        setPill(badgeGep, "warn", "Retrying");
        subGep.textContent = "Connecting — enter a match to activate";
      }

      gameIdEl.textContent = st.detectedGameId  ?? "-";
      instIdEl.textContent = st.detectedInstanceId ?? "-";
      setBrandPulse(!running || (running && (!gepOk || !streaming)));
      return;
    }

    if (e.id === "diag") {
      log((e.content && e.content.msg) ? String(e.content.msg) : "");
      return;
    }

    if (e.id === "messages_saved") {
      // Background saved new session messages to localStorage — reload rate panel
      loadRatePanel();
      return;
    }

  });

  function showRateStatus(msg, ok) {
    rateStatus.textContent = msg;
    rateStatus.className = "rate-status " + (ok ? "ok" : "err");
  }

  function initBridge() {
    try {
      overwolf.windows.obtainDeclaredWindow("background", (res) => {
        if (!res || !res.window || !res.window.id) return;
        backgroundId = res.window.id;
        sendToBackground("settings_get", {});
        sendToBackground("status_get", {});
        setInterval(() => { sendToBackground("status_get", {}); }, 1500);
      });
    } catch(e) {}
  }

  applyUi();
  initBridge();
</script>
</body>
</html>
